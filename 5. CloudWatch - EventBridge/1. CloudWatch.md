## Cloudwatch

### Pillars of observability (Ba trá»¥ cá»™t cá»§a kháº£ nÄƒng quan sÃ¡t)

![Image](../images/cloudwatch/cloudwatch-pillars-of-observability.png)

**Observability lÃ  gÃ¬?**  
LÃ  kháº£ nÄƒng Ä‘o lÆ°á»ng vÃ  hiá»ƒu cÃ¡ch há»‡ thá»‘ng ná»™i bá»™ hoáº¡t Ä‘á»™ng nháº±m tráº£ lá»i cÃ¡c cÃ¢u há»i liÃªn quan Ä‘áº¿n hiá»‡u nÄƒng, kháº£ nÄƒng chá»‹u lá»—i, báº£o máº­t vÃ  lá»—i cá»§a há»‡ thá»‘ng / á»©ng dá»¥ng.

Äá»ƒ Ä‘áº¡t Ä‘Æ°á»£c kháº£ nÄƒng quan sÃ¡t (observability), báº¡n cáº§n sá»­ dá»¥ng Metrics (chá»‰ sá»‘), Logs (nháº­t kÃ½) vÃ  Traces (váº¿t truy dáº¥u). Báº¡n pháº£i sá»­ dá»¥ng chÃºng cÃ¹ng nhau; náº¿u dÃ¹ng riÃªng láº» thÃ¬ sáº½ khÃ´ng Ä‘áº¡t Ä‘Æ°á»£c kháº£ nÄƒng quan sÃ¡t thá»±c sá»±.

**Metrics (Chá»‰ sá»‘)**  
Má»™t giÃ¡ trá»‹ Ä‘Æ°á»£c Ä‘o lÆ°á»ng trong má»™t khoáº£ng thá»i gian.  
VÃ­ dá»¥: Náº¿u chÃºng ta Ä‘o má»©c sá»­ dá»¥ng CPU vÃ  tá»•ng há»£p nÃ³ theo thá»i gian, chÃºng ta cÃ³ thá»ƒ cÃ³ má»™t chá»‰ sá»‘ CPU trung bÃ¬nh (Average CPU metric).

**Logs (Nháº­t kÃ½)**  
Má»™t tá»‡p vÄƒn báº£n trong Ä‘Ã³ má»—i dÃ²ng chá»©a dá»¯ liá»‡u sá»± kiá»‡n vá» nhá»¯ng gÃ¬ Ä‘Ã£ xáº£y ra táº¡i má»™t thá»i Ä‘iá»ƒm nháº¥t Ä‘á»‹nh.

**Traces (Váº¿t truy dáº¥u)**
Lá»‹ch sá»­ cá»§a má»™t yÃªu cáº§u khi nÃ³ Ä‘i qua nhiá»u á»©ng dá»¥ng / dá»‹ch vá»¥ khÃ¡c nhau Ä‘á»ƒ chÃºng ta cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh chÃ­nh xÃ¡c hiá»‡u nÄƒng hoáº·c lá»—i.

ğŸ“Œ **Alarm (Cáº£nh bÃ¡o)** Ä‘Ã´i khi Ä‘Æ°á»£c xem lÃ  trá»¥ cá»™t thá»© tÆ° cá»§a kháº£ nÄƒng quan sÃ¡t.

### Introduction to Cloudwatch

![Image](../images/cloudwatch/cloudwatch-introduction-1.png)

AWS CloudWatch lÃ  giáº£i phÃ¡p giÃ¡m sÃ¡t (monitoring solution) cho cÃ¡c tÃ i nguyÃªn AWS cá»§a báº¡n.

CloudWatch lÃ  má»™t dá»‹ch vá»¥ â€œÃ´ dÃ¹â€ (umbrella service), nghÄ©a lÃ  nÃ³ thá»±c cháº¥t lÃ  táº­p há»£p cá»§a nhiá»u cÃ´ng cá»¥ giÃ¡m sÃ¡t, bao gá»“m:

- Logs â€” má»i loáº¡i dá»¯ liá»‡u log tÃ¹y chá»‰nh, log á»©ng dá»¥ng, log Nginx, log Lambda.
- Metrics â€” táº­p há»£p dá»¯ liá»‡u Ä‘Æ°á»£c sáº¯p xáº¿p theo thá»i gian; má»™t biáº¿n cáº§n theo dÃµi (vÃ­ dá»¥: má»©c sá»­ dá»¥ng bá»™ nhá»›).
- Events â€” kÃ­ch hoáº¡t sá»± kiá»‡n dá»±a trÃªn Ä‘iá»u kiá»‡n (vÃ­ dá»¥: snapshot mÃ¡y chá»§ má»—i giá» â€” hiá»‡n Ä‘Æ°á»£c gá»i lÃ  Amazon EventBridge).
- Alarms â€” gá»­i thÃ´ng bÃ¡o khi cÃ¡c chá»‰ sá»‘ (metrics) vÆ°á»£t ngÆ°á»¡ng Ä‘Ã£ Ä‘á»‹nh.
- Dashboards â€” táº¡o biá»ƒu Ä‘á»“ trá»±c quan dá»±a trÃªn cÃ¡c chá»‰ sá»‘.
- ServiceLens â€” trá»±c quan hÃ³a vÃ  phÃ¢n tÃ­ch tÃ¬nh tráº¡ng, hiá»‡u nÄƒng, vÃ  kháº£ nÄƒng sáºµn sÃ ng cá»§a á»©ng dá»¥ng trong má»™t nÆ¡i duy nháº¥t.
- Container Insights â€” thu tháº­p, tá»•ng há»£p vÃ  tÃ³m táº¯t cÃ¡c chá»‰ sá»‘ vÃ  log tá»« á»©ng dá»¥ng container vÃ  microservice.
- Synthetics â€” kiá»ƒm tra á»©ng dá»¥ng web Ä‘á»ƒ xem cÃ³ bá»‹ lá»—i khÃ´ng.
- Contributor Insights â€” xem cÃ¡c yáº¿u tá»‘ hÃ ng Ä‘áº§u áº£nh hÆ°á»Ÿng Ä‘áº¿n hiá»‡u suáº¥t cá»§a há»‡ thá»‘ng vÃ  á»©ng dá»¥ng trong thá»i gian thá»±c.

### Cloudwatch Logs

![Image](../images/cloudwatch/cloudwatch-introduction-2.png)

CloudWatch Logs lÃ  ná»n táº£ng cho háº§u háº¿t cÃ¡c dá»‹ch vá»¥ CloudWatch khÃ¡c.  
Tá»©c lÃ : dá»¯ liá»‡u log Ä‘Æ°á»£c thu tháº­p trÆ°á»›c â†’ chuyá»ƒn thÃ nh metric â†’ tá»« Ä‘Ã³ cÃ¡c dá»‹ch vá»¥ khÃ¡c nhÆ° dashboard, alarm, events... cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng. ToÃ n bá»™ há»‡ thá»‘ng CloudWatch Ä‘á»u xoay quanh Logs.

![Image](../images/cloudwatch/cloudwatch-logs.png)

CloudWatch Logs Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ giÃ¡m sÃ¡t (monitor), lÆ°u trá»¯ (store) vÃ  truy cáº­p (access) cÃ¡c tá»‡p log cá»§a báº¡n.
CloudWatch lÃ  má»™t dá»‹ch vá»¥ quáº£n lÃ½ log táº­p trung (centralized log management service).

**Export Logs to S3**  
Báº¡n cÃ³ thá»ƒ xuáº¥t log sang S3 Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ nhÆ° phÃ¢n tÃ­ch tÃ¹y chá»‰nh.

**Stream to Elasticsearch Service (ES)**  
Báº¡n cÃ³ thá»ƒ truyá»n log Ä‘áº¿n má»™t cá»¥m ES gáº§n nhÆ° theo thá»i gian thá»±c Ä‘á»ƒ cÃ³ kháº£ nÄƒng tÃ¬m kiáº¿m toÃ n vÄƒn máº¡nh máº½ hÆ¡n hoáº·c sá»­ dá»¥ng vá»›i ELK stack.

**Stream CloudTrail Events to CloudWatch Logs**  
Báº¡n cÃ³ thá»ƒ báº­t CloudTrail Ä‘á»ƒ truyá»n dá»¯ liá»‡u sá»± kiá»‡n Ä‘áº¿n má»™t Log Group cá»§a CloudWatch.

_AWS CloudTrail lÃ  dá»‹ch vá»¥ ghi láº¡i toÃ n bá»™ hoáº¡t Ä‘á»™ng (event logs) xáº£y ra trong tÃ i khoáº£n AWS cá»§a báº¡n (báº¡n Ä‘Ã£ lÃ m gÃ¬, á»Ÿ Ä‘Ã¢u vÃ  khi nÃ o?)_

**Log Security**  
Theo máº·c Ä‘á»‹nh, cÃ¡c Log Group Ä‘Æ°á»£c mÃ£ hÃ³a khi lÆ°u trá»¯ báº±ng SSE (Server-Side Encryption). Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng Customer Master Key (CMK) riÃªng cá»§a mÃ¬nh vá»›i AWS KMS.

**Log Filtering**  
Log cÃ³ thá»ƒ Ä‘Æ°á»£c lá»c báº±ng cÃº phÃ¡p lá»c (Filtering Syntax), vÃ  CloudWatch Logs cÃ³ dá»‹ch vá»¥ con lÃ  CloudWatch Insights.

_CloudWatch Logs Insights lÃ  cÃ´ng cá»¥ truy váº¥n (query tool - tÆ°Æ¡ng tá»± SQL) máº¡nh máº½ trong AWS CloudWatch, Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ tÃ¬m kiáº¿m, phÃ¢n tÃ­ch vÃ  trá»±c quan hÃ³a dá»¯ liá»‡u log má»™t cÃ¡ch nhanh chÃ³ng._

**Log Retention**  
Theo máº·c Ä‘á»‹nh, log Ä‘Æ°á»£c giá»¯ vÃ´ thá»i háº¡n vÃ  khÃ´ng bao giá» háº¿t háº¡n. Báº¡n cÃ³ thá»ƒ Ä‘iá»u chá»‰nh chÃ­nh sÃ¡ch lÆ°u trá»¯ cho tá»«ng Log Group :

- Giá»¯ vÃ´ thá»i háº¡n
- Chá»n thá»i gian lÆ°u trá»¯ tá»« 1 ngÃ y Ä‘áº¿n 10 nÄƒm

### Cloudwatch Log Group

![Image](../images/cloudwatch/cloudwatch-log-group.png)

Má»™t táº­p há»£p cÃ¡c luá»“ng nháº­t kÃ½ (log streams). ThÃ´ng thÆ°á»ng, cÃ¡c nhÃ³m nháº­t kÃ½ Ä‘Æ°á»£c Ä‘áº·t tÃªn báº±ng cÃº phÃ¡p dáº¥u gáº¡ch chÃ©o:

VÃ­ dá»¥:

```
/exampro/prod/app
/exampro/prod/db
/exampro/dev/app
/exampro/dev/db
```

Báº¡n cÃ³ thá»ƒ Ä‘áº·t thá»i gian lÆ°u trá»¯ cho má»™t Log Group trong khoáº£ng tá»« _KhÃ´ng bao giá» háº¿t háº¡n (Never expire)_ Ä‘áº¿n _120 thÃ¡ng (10 nÄƒm)_.

### Cloudwatch Log Stream

![Image](../images/cloudwatch/cloudwatch-log-stream.png)

Má»™t log stream Ä‘áº¡i diá»‡n cho má»™t chuá»—i cÃ¡c sá»± kiá»‡n (sequence of events) tá»« má»™t á»©ng dá»¥ng hoáº·c instance Ä‘ang Ä‘Æ°á»£c giÃ¡m sÃ¡t.

Báº¡n cÃ³ thá»ƒ táº¡o Log Stream thá»§ cÃ´ng, nhÆ°ng thÃ´ng thÆ°á»ng dá»‹ch vá»¥ báº¡n Ä‘ang sá»­ dá»¥ng sáº½ tá»± Ä‘á»™ng táº¡o ra.

VÃ­ dá»¥:

**Log Group cho hÃ m Lambda**  
CÃ¡c Log Streams Ä‘Æ°á»£c Ä‘áº·t tÃªn theo instance Ä‘ang cháº¡y.
Do Lambda thÆ°á»ng cháº¡y trÃªn cÃ¡c instance má»›i, nÃªn tÃªn log stream sáº½ chá»©a dáº¥u thá»i gian (timestamp).

**Log Group cho á»©ng dá»¥ng cháº¡y trÃªn EC2**  
CÃ¡c Log Streams Ä‘Æ°á»£c Ä‘áº·t tÃªn theo ID cá»§a instance Ä‘ang cháº¡y (Instance ID).

**Log Group cho AWS Glue**  
CÃ¡c Log Streams Ä‘Æ°á»£c Ä‘áº·t tÃªn theo Glue Jobs.

### Cloudwatch Log Events

![Image](../images/cloudwatch/cloudwatch-log-events.png)

Log Events lÃ  Ä‘áº¡i diá»‡n cho má»™t sá»± kiá»‡n riÃªng láº» trong má»™t tá»‡p log. CÃ¡c sá»± kiá»‡n log cÃ³ thá»ƒ Ä‘Æ°á»£c nhÃ¬n tháº¥y trong má»™t Log Stream.

Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng bá»™ lá»c sá»± kiá»‡n Ä‘á»ƒ lá»c ra cÃ¡c log dá»±a trÃªn Pattern matching syntax (Ä‘Æ¡n giáº£n hoáº·c phá»©c táº¡p)

### Cloudwatch Log Insights

![Image](../images/cloudwatch/cloudwatch-logs-insights.png)

CloudWatch Logs Insights cho phÃ©p báº¡n tÃ¬m kiáº¿m vÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u log CloudWatch cá»§a mÃ¬nh má»™t cÃ¡ch tÆ°Æ¡ng tÃ¡c vÃ  cÃ³ cÃ¡c Æ°u Ä‘iá»ƒm sau:

- Lá»c máº¡nh máº½ hÆ¡n so vá»›i viá»‡c sá»­ dá»¥ng tÃ­nh nÄƒng Sá»± kiá»‡n Lá»c Ä‘Æ¡n giáº£n trong Luá»“ng Log (Log Stream).
- Ãt gÃ¡nh náº·ng hÆ¡n so vá»›i viá»‡c pháº£i xuáº¥t log ra S3 vÃ  phÃ¢n tÃ­ch chÃºng qua Athena.

CloudWatch Logs Insights há»— trá»£ táº¥t cáº£ cÃ¡c loáº¡i log.

CloudWatch Logs Insights thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng qua console Ä‘á»ƒ thá»±c hiá»‡n truy váº¥n ad-hoc (truy váº¥n tá»©c thá»i) Ä‘á»‘i vá»›i cÃ¡c nhÃ³m log (log groups).

CloudWatch Insights cÃ³ ngÃ´n ngá»¯ riÃªng gá»i lÃ : CÃº phÃ¡p Truy váº¥n CloudWatch Logs Insights

```
filter action="REJECT"
| stats count(*) as numRejections by srcAddr
| sort numRejections desc
| limit 20
```

Äáº·c Ä‘iá»ƒm:

- Má»™t yÃªu cáº§u truy váº¥n cÃ³ thá»ƒ truy váº¥n tá»‘i Ä‘a 20 nhÃ³m log.
- CÃ¡c truy váº¥n sáº½ háº¿t thá»i gian sau 15 phÃºt, náº¿u chÃºng chÆ°a hoÃ n thÃ nh.
- Káº¿t quáº£ truy váº¥n Ä‘Æ°á»£c lÆ°u trong 7 ngÃ y.

![Image](../images/cloudwatch/cloudwatch-logs-insights-example.png)

AWS cung cáº¥p cÃ¡c truy váº¥n máº«u cÃ³ thá»ƒ giÃºp báº¡n báº¯t Ä‘áº§u vá»›i cÃ¡c tÃ¡c vá»¥ phá»• biáº¿n, vÃ  giÃºp viá»‡c há»c Query Syntax dá»… dÃ ng hÆ¡n.

Báº¡n cÃ³ thá»ƒ táº¡o vÃ  lÆ°u cÃ¡c truy váº¥n cá»§a riÃªng mÃ¬nh Ä‘á»ƒ giÃºp cÃ¡c cÃ´ng viá»‡c láº·p Ä‘i láº·p láº¡i trong tÆ°Æ¡ng lai dá»… dÃ ng hÆ¡n.

### Cloudwatch Insights - Discovered Fields

![Image](../images/cloudwatch/cloudwatch-insights-discovered-fields-1.png)

Khi CloudWatch Insights Ä‘á»c log, nÃ³ sáº½ phÃ¢n tÃ­ch cÃ¡c sá»± kiá»‡n log vÃ  cá»‘ gáº¯ng cáº¥u trÃºc ná»™i dung báº±ng cÃ¡ch táº¡o ra cÃ¡c trÆ°á»ng (fields) mÃ  sau Ä‘Ã³ báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng trong truy váº¥n cá»§a mÃ¬nh.

CloudWatch Logs Insights chÃ¨n kÃ½ hiá»‡u @ vÃ o Ä‘áº§u cÃ¡c trÆ°á»ng mÃ  nÃ³ táº¡o ra.

NÄƒm trÆ°á»ng há»‡ thá»‘ng (Five system fields) sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng táº¡o:

- **@message** â€” sá»± kiá»‡n log thÃ´, chÆ°a Ä‘Æ°á»£c phÃ¢n tÃ­ch cÃº phÃ¡p.
- **@timestamp** â€” dáº¥u thá»i gian sá»± kiá»‡n cÃ³ trong trÆ°á»ng dáº¥u thá»i gian cá»§a sá»± kiá»‡n log.
- **@ingestionTime** â€” thá»i gian mÃ  sá»± kiá»‡n log Ä‘Æ°á»£c nháº­n bá»Ÿi CloudWatch Logs.
- **@logStream** â€” tÃªn cá»§a luá»“ng log mÃ  sá»± kiá»‡n log Ä‘Æ°á»£c thÃªm vÃ o.
- **@log** â€” lÃ  má»™t Ä‘á»‹nh danh nhÃ³m log (log group identifier) dÆ°á»›i dáº¡ng `account-id:log-group-name`.

![Image](../images/cloudwatch/cloudwatch-insights-discovered-fields-2.png)

Logs Insights tá»± Ä‘á»™ng khÃ¡m phÃ¡ cÃ¡c trÆ°á»ng cho log tá»« cÃ¡c dá»‹ch vá»¥ AWS phá»• biáº¿n:

Amazon VPC Flow Logs  
`@timestamp, accountId, action, bytes, dstAddr, srcPort, v.v.`

Amazon Route 53  
`@timestamp, edgeLocation, queryName, responseCode, v.v.`

AWS Lambda  
`@requestId, @duration, @billedDuration, @maxMemoryUsed, @xrayTraceId, v.v.`

AWS CloudTrail  
`eventVersion, eventTime, eventName, sourceIPAddress, userAgent, v.v. `

JSON Logs  
`CÃ¡c cáº·p key-value trong log JSON sáº½ Ä‘Æ°á»£c chuyá»ƒn thÃ nh cÃ¡c trÆ°á»ng (fields).`

Xá»­ lÃ½ CÃ¡c Loáº¡i Log KhÃ¡c  
Äá»‘i vá»›i cÃ¡c trÆ°á»ng mÃ  Logs Insights khÃ´ng tá»± Ä‘á»™ng khÃ¡m phÃ¡. Báº¡n cÃ³ thá»ƒ sá»­ dá»¥ng lá»‡nh `parse` Ä‘á»ƒ trÃ­ch xuáº¥t vÃ  táº¡o cÃ¡c trÆ°á»ng táº¡m thá»i (ephemeral fields) Ä‘á»ƒ sá»­ dá»¥ng trong truy váº¥n Ä‘Ã³.

![Image](../images/cloudwatch/cloudwatch-insights-discovered-fields-3.png)

Thay vÃ¬ gÃµ thÃ¬ báº¡n cÃ³ thá»ƒ chá»n field Ä‘Æ°á»£c liá»‡t kÃª sáºµn.

### Cloudwatch Metrics

![Image](../images/cloudwatch/cloudwatch-metrics.png)

Má»™t CloudWatch Metric Ä‘áº¡i diá»‡n cho má»™t táº­p há»£p cÃ¡c Ä‘iá»ƒm dá»¯ liá»‡u Ä‘Æ°á»£c sáº¯p xáº¿p theo thá»i gian (time-ordered set of data points). ÄÃ³ lÃ  má»™t biáº¿n Ä‘Æ°á»£c theo dÃµi theo thá»i gian.

CloudWatch Ä‘i kÃ¨m vá»›i nhiá»u chá»‰ sá»‘ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trÆ°á»›c mÃ  thÆ°á»ng Ä‘Æ°á»£c phÃ¢n loáº¡i theo tÃªn miá»n (Namespace) cá»§a Dá»‹ch vá»¥ AWS.

### Cloudwatch - Custom Metrics and High Resolutions

![Image](../images/cloudwatch/cloudwatch-custom-metrics-and-high-resolution.png)

Báº¡n cÃ³ thá»ƒ tÃ¹y chá»‰nh metrics (publish Custom Metrics) cá»§a riÃªng mÃ¬nh báº±ng cÃ¡ch sá»­ dá»¥ng AWS CLI hoáº·c SDK.

```
aws cloudwatch put-metric-data \
--metric-name Enterprise-D \
--namespace Starfleet \
--unit Bytes \
--value 231213412 \
--dimensions HullIntegrity=100,Shield=70,Thrusters=maximum
```

**Resolution**: Táº§n suáº¥t thu nháº­p hoáº·c gá»­i dá»¯ liá»‡u (thÃ´ng qua API,...)

Khi báº¡n tÃ¹y chá»‰nh metrics, báº¡n cÃ³ thá»ƒ xÃ¡c Ä‘á»‹nh Resolution lÃ  má»™t trong hai:

- Standard resolution (1 phÃºt)
- High resolution (> 1 phÃºt Ä‘áº¿n 1 giÃ¢y)

Vá»›i High Resolution, báº¡n cÃ³ thá»ƒ theo dÃµi trong cÃ¡c khoáº£ng thá»i gian:

- 1 giÃ¢y
- 5 giÃ¢y
- 10 giÃ¢y
- 30 giÃ¢y
- bá»™i sá»‘ cá»§a 60 giÃ¢y.

### Cloudwatch Availability of Data

![Image](../images/cloudwatch/cloudwatch-availability-of-data.png)

Khi má»™t Dá»‹ch vá»¥ AWS gá»­i dá»¯ liá»‡u Ä‘áº¿n CloudWatch, táº§n suáº¥t thu tháº­p dá»¯ liá»‡u (Availability of data) sáº½ khÃ¡c nhau tÃ¹y thuá»™c vÃ o Dá»‹ch vá»¥ AWS Ä‘Ã³:

|                       | Elastic Compute Cloud (EC2) | CÃ¡c Dá»‹ch vá»¥ KhÃ¡c (Other Services) |
| :-------------------- | :-------------------------- | :-------------------------------- |
| **GiÃ¡m sÃ¡t CÆ¡ báº£n**   | Khoáº£ng thá»i gian 5 phÃºt     | 1 phÃºt / 3 phÃºt / 5 phÃºt          |
| **GiÃ¡m sÃ¡t Chi tiáº¿t** | Khoáº£ng thá»i gian 1 phÃºt     | KhÃ´ng Ã¡p dá»¥ng (N/A)               |

_Ghi chÃº: Pháº§n lá»›n kháº£ nÄƒng sáºµn cÃ³ cá»§a dá»¯ liá»‡u trong cÃ¡c dá»‹ch vá»¥ AWS lÃ  1 phÃºt._

### Cloudwatch Log Collection - Agent and Host level metrics

![Image](../images/cloudwatch/cloudwatch-agent-and-host-level-metrics.png)

Má»™t sá»‘ chá»‰ sá»‘ mÃ  báº¡n cÃ³ thá»ƒ nghÄ© ráº±ng Ä‘Ã£ Ä‘Æ°á»£c theo dÃµi máº·c Ä‘á»‹nh cho cÃ¡c phiÃªn báº£n EC2 láº¡i khÃ´ng pháº£i nhÆ° tháº¿, nÃ³ Ä‘Ã²i há»i pháº£i cÃ i Ä‘áº·t CloudWatch Agent.

**CÃ¡c Chá»‰ sá»‘ Má»©c MÃ¡y chá»§ (Host Level Metrics)**

ÄÃ¢y lÃ  nhá»¯ng chá»‰ sá»‘ báº¡n nháº­n Ä‘Æ°á»£c mÃ  khÃ´ng cáº§n cÃ i Ä‘áº·t Agent:

- CPU Usage (Má»©c sá»­ dá»¥ng CPU)
- Network Usage (Má»©c sá»­ dá»¥ng máº¡ng)
- Disk Usage (Má»©c sá»­ dá»¥ng ÄÄ©a)
- Status Checks (Kiá»ƒm tra tráº¡ng thÃ¡i)
  - Tráº¡ng thÃ¡i cá»§a Hypervisor Ä‘ang cháº¡y bÃªn dÆ°á»›i mÃ¡y áº£o.
  - Tráº¡ng thÃ¡i phiÃªn báº£n EC2 Ä‘ang cháº¡y bÃªn dÆ°á»›i mÃ¡y áº£o.

**CÃ¡c Chá»‰ sá»‘ Má»©c Agent (Agent Level Metrics)**

ÄÃ¢y lÃ  nhá»¯ng chá»‰ sá»‘ báº¡n nháº­n Ä‘Æ°á»£c khi cÃ i Ä‘áº·t Agent:

- Memory utilization (Má»©c sá»­ dá»¥ng Bá»™ nhá»›)
- Disk Swap utilization (Má»©c sá»­ dá»¥ng Disk Swap - cÃ²n gá»i lÃ  RAM áº£o cá»§a Linux)
- Disk Space utilization (Má»©c sá»­ dá»¥ng Dung lÆ°á»£ng Ä‘Ä©a - cÃ²n gá»i lÃ  RAM áº£o cá»§a Windows)
- Page file utilization (xem chÃº thÃ­ch bÃªn dÆ°á»›i)
- Log collection (Thu tháº­p log)

_**Page File (hoáº·c Swap trÃªn Linux)** lÃ  vÃ¹ng trÃªn Ä‘Ä©a mÃ  há»‡ Ä‘iá»u hÃ nh dÃ¹ng nhÆ° bá»™ nhá»› áº£o (virtual memory) khi RAM váº­t lÃ½ Ä‘Ã£ Ä‘áº§y.  
**Page File Utilization (%)** lÃ  tá»· lá»‡ pháº§n trÄƒm dung lÆ°á»£ng cá»§a Page file hiá»‡n Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng._

### Cloudwatch Agent

![Image](../images/cloudwatch/cloudwatch-agents.png)

CloudWatch Agent cÃ³ thá»ƒ gá»­i cÃ¡c log Ä‘ang cháº¡y trÃªn EC2 instance cá»§a báº¡n Ä‘áº¿n má»™t CloudWatch Log Group.

Äá»ƒ gá»­i log thÃ¬ cáº§n:

- Cáº¥u hÃ¬nh cá»§a Agent cáº§n Ä‘Æ°á»£c cáº­p nháº­t Ä‘á»ƒ bao gá»“m cÃ¡c log cáº§n gá»­i.
- Dá»‹ch vá»¥ CloudWatch Agent cáº§n Ä‘Æ°á»£c khá»Ÿi Ä‘á»™ng láº¡i.

Tá»‡p cáº¥u hÃ¬nh cá»§a Agent náº±m táº¡i: `/etc/awslogs/awslogs.conf`

Báº¡n chá»‰ Ä‘á»‹nh vá»‹ trÃ­ cá»§a tá»‡p log vÃ  nhÃ³m log (log group) mÃ  báº¡n muá»‘n gá»­i log Ä‘áº¿n. File cáº¥u hÃ¬nh tÆ°Æ¡ng tá»± nhÆ° sau:

```
[exampro_application_log]
log_group_name = /exampro/rails/logs/production
log_stream_name = {instance_id}
datetime_format = %Y-%m-%dT%H:%M:%S.%f
file = /var/www/my-app/current/log/production.log*
```

Lá»‡nh khá»Ÿi Ä‘á»™ng láº¡i CloudWatch Agent:

```
sudo service awslogsd stop
sudo service awslogsd start
```

### Installing the Cloudwatch Agent

![Image](../images/cloudwatch/cloudwatch-agents-installing.png)

CloudWatch Agent cÃ³ thá»ƒ Ä‘Æ°á»£c cÃ i Ä‘áº·t báº±ng AWS Systems Manager (SSM) thÃ´ng qua Run Command trÃªn EC2 instance má»¥c tiÃªu.

**LÆ°u Ã½:** Báº¡n pháº£i gÃ¡n IAM role cÃ³ tÃªn `CloudWatchAgentServerRole` cho EC2 instance Ä‘á»ƒ cÃ³ thá»ƒ cháº¡y Ä‘Æ°á»£c agent trÃªn instance Ä‘Ã³.

## Cloudwatch Alarms

![Image](../images/cloudwatch/cloudwatch-alarm.png)

Má»™t CloudWatch Alarm giÃ¡m sÃ¡t má»™t CloudWatch Metric dá»±a trÃªn má»™t ngÆ°á»¡ng Ä‘Ã£ Ä‘á»‹nh nghÄ©a. Khi chá»‰ sá»‘ vÆ°á»£t ngÆ°á»¡ng thÃ¬ nÃ³ thay Ä‘á»•i tráº¡ng thÃ¡i.

Khi nÃ³ thay Ä‘á»•i tráº¡ng thÃ¡i, chÃºng ta cÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a hÃ nh Ä‘á»™ng nÃ o nÃªn Ä‘Æ°á»£c kÃ­ch hoáº¡t.

Tráº¡ng thÃ¡i cá»§a Metric Alarm

- OK: Chá»‰ sá»‘ hoáº·c biá»ƒu thá»©c náº±m trong ngÆ°á»¡ng Ä‘Ã£ Ä‘á»‹nh nghÄ©a.
- ALARM: Chá»‰ sá»‘ hoáº·c biá»ƒu thá»©c náº±m ngoÃ i ngÆ°á»¡ng Ä‘Ã£ Ä‘á»‹nh nghÄ©a.
- INSUFFICIENT_DATA:
  - Alarm vá»«a má»›i khá»Ÿi Ä‘á»™ng.
  - Chá»‰ sá»‘ khÃ´ng kháº£ dá»¥ng.
  - KhÃ´ng Ä‘á»§ dá»¯ liá»‡u kháº£ dá»¥ng.

CÃ¡c HÃ nh Ä‘á»™ng (Actions) cÃ³ thá»ƒ kÃ­ch hoáº¡t:

- Notification (ThÃ´ng bÃ¡o)
- Auto Scaling Group
- EC2 Action (HÃ nh Ä‘á»™ng EC2)

### Anatomy of Alarm

![Image](../images/cloudwatch/cloudwatch-alarm-anatomy.png)

Metric: Dá»¯ liá»‡u thá»±c táº¿ chÃºng ta Ä‘ang Ä‘o lÆ°á»ng.

Threshold Condition (Äiá»u kiá»‡n NgÆ°á»¡ng): XÃ¡c Ä‘á»‹nh khi nÃ o má»™t Ä‘iá»ƒm dá»¯ liá»‡u bá»‹ vi pháº¡m.

Data point: Biá»ƒu thá»‹ giÃ¡ trá»‹ Ä‘o lÆ°á»ng cá»§a chá»‰ sá»‘ táº¡i má»™t khoáº£ng thá»i gian nháº¥t Ä‘á»‹nh.

Period (Khoáº£ng thá»i gian): Táº§n suáº¥t kiá»ƒm tra Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ nháº±m trigger Alarm.

Evaluation Periods (Khoáº£ng thá»i gian Ä‘Ã¡nh giÃ¡): Sá»‘ lÆ°á»£ng cÃ¡c khoáº£ng thá»i gian trÆ°á»›c Ä‘Ã³.

Datapoints to alarm (Sá»‘ Ä‘iá»ƒm dá»¯ liá»‡u Ä‘á»ƒ kÃ­ch hoáº¡t bÃ¡o thá»©c):  
Vd: Ä‘iá»ƒm dá»¯ liá»‡u bá»‹ vi pháº¡m trong khoáº£ng thá»i gian Ä‘Ã¡nh giÃ¡ kÃ©o dÃ i 4 khoáº£ng thá»i gian trÆ°á»›c Ä‘Ã³. ÄÃ¢y lÃ  Ä‘iá»u kÃ­ch hoáº¡t bÃ¡o thá»©c.

### Conditions

![Image](../images/cloudwatch/cloudwatch-alarm-condition.png)

Khi táº¡o má»™t Alarm, cáº§n xÃ¡c Ä‘á»‹nh ngÆ°á»¡ng (Threshold).

- Loáº¡i phá»• biáº¿n nháº¥t lÃ  Static Threshold.

Sau Ä‘Ã³, XÃ¡c Ä‘á»‹nh Ä‘iá»u kiá»‡n cá»§a Alarm.

Sau Ä‘Ã³, XÃ¡c Ä‘á»‹nh giÃ¡ trá»‹ cá»§a Threshold.

Vd: Táº¡o má»™t CloudWatch Alarm vÃ¬ báº¡n muá»‘n trÃ¡nh cÃ¡c khoáº£n phÃ­ báº¥t ngá».

- Sá»­ dá»¥ng chá»‰ sá»‘ EstimatedCharges.
- Äáº·t Threshold Type thÃ nh Static.
- Äáº·t Alarm condition thÃ nh Greater.
- Äáº·t giÃ¡ trá»‹ thÃ nh 50 USD.

![Image](../images/cloudwatch/cloudwatch-alarm-condition-ex.png)

CÃ³ thá»ƒ cÃ³ cÃ¡c Ä‘iá»ƒm dá»¯ liá»‡u láº·p láº¡i vÆ°á»£t quÃ¡ ngÆ°á»¡ng cá»‘ Ä‘á»‹nh, nhÆ°ng Ä‘iá»u nÃ y sáº½ khÃ´ng Ä‘Æ°á»£c coi lÃ  "hÃ nh vi báº¥t thÆ°á»ng"

- VÃ­ dá»¥: Má»—i sÃ¡ng, táº¥t cáº£ nhÃ¢n viÃªn trong cÃ´ng ty cá»§a báº¡n Ä‘Äƒng nháº­p nÃªn báº¡n cÃ³ má»™t Ä‘á»£t tÄƒng lÆ°u lÆ°á»£ng trong 30 phÃºt.

Sá»­ dá»¥ng loáº¡i Static Threshold sáº½ kÃ­ch hoáº¡t Alarm vÃ  nhá»¯ng trÆ°á»ng há»£p nÃ y sáº½ lÃ  false-positive.

Sá»­ dá»¥ng Anomaly detection Ä‘á»ƒ cÃ³ thá»ƒ Ä‘á»‹nh nghÄ©a má»™t dáº£i (band) lÃ m ngÆ°á»¡ng.

### Composite Alarms

![Image](../images/cloudwatch/cloudwatch-alarm-composite.png)

Composite Alarms lÃ  cÃ¡c alarm giÃ¡m sÃ¡t nhá»¯ng alarm khÃ¡c. Viá»‡c sá»­ dá»¥ng composite alarms cÃ³ thá»ƒ giÃºp báº¡n giáº£m nhiá»…u cáº£nh bÃ¡o.

HÃ£y tÆ°á»Ÿng tÆ°á»£ng báº¡n cÃ³ hai Alarm vÃ  báº¡n cáº¥u hÃ¬nh chÃºng khÃ´ng cÃ³ hÃ nh Ä‘á»™ng:

- CPU Utilization
- NetworkIn

Báº¡n chá»n cáº£ hai Alarms vÃ  táº¡o má»™t Composite Alarm. Sau Ä‘Ã³ báº¡n thiáº¿t láº­p cÃ¡c Ä‘iá»u kiá»‡n Alarm:

```
ALARM("CPU_Utilization") OR
ALARM("Network_In")
```

Chá»n Alarm state trigger lÃ  `In Alarm` vÃ  `Select an existing SNS Topic`

Giáº£i thÃ­ch:

Náº¿u tá»«ng Alarm tá»± nÃ³ chuyá»ƒn sang tráº¡ng thÃ¡i `In Alarm`, chÃºng sáº½ khÃ´ng gá»­i thÃ´ng bÃ¡o, khÃ´ng cháº¡y Auto Scaling, khÃ´ng lÃ m gÃ¬ cáº£, má»¥c Ä‘Ã­ch lÃ  khÃ´ng muá»‘n bá»‹ spam quÃ¡ nhiá»u cáº£nh bÃ¡o.

Sau khi táº¡o má»™t Composite Alarm, chá»‰ cáº§n má»™t trong hai alarm con chuyá»ƒn sang `In Alarm`, CA sáº½ kÃ­ch hoáº¡t vÃ  lÃ  Alarm duy nháº¥t gá»­i thÃ´ng bÃ¡o theo máº«u SNS Ä‘Ã£ táº¡o tá»« trÆ°á»›c.
